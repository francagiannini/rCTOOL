---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# rCTOOL

<!-- badges: start -->
<!-- badges: end -->

rCTOOL is an open-source R package, that encapsulates the capabilities of C-TOOL while addressing its implementation limitations. The aim consists of providing a user-friendly interface, facilitates running multiple scenarios, and offers comprehensive documentation and licensing information. This package streamlines the use of C-TOOL, making it more accessible and effective for potential users

## Installation

You can install the development version of rCTOOL from [GitHub](https://github.com/) with:

``` {r, eval = FALSE, message = FALSE}
# install.packages("devtools")
devtools::install_github("francagiannini/rCTOOL")
```

## Basic example

This is a basic example that showcases the potential use of rCTOOL. This is illustrated with samples from the Askov long-term trials in Denmark.

```{r, message = FALSE, warning = FALSE}
library(rCTOOL)
library(tidyverse)

# load data ----
data('basic_example')
data('scenario_temperature') # this is equivalent to set_monthly_temperature_data(coords=c(9.114015, 55.47163), yr_start=1951, yr_end=2019)
```

Below the basic_example and temperature datasets are exemplified.
```{r }
head(basic_example, 2)
```
```{r }
head(scenario_temperature, 2)
```

It is mandatory to define the timeperiod, Carbon inputs (from manure and/or plant), Management (months where the inputs are applied) and soil configurations as well as temperature.
In this basic example, the temperature was already exported using the package "easyclimate" for 1951-2019; basic_example contains the annual C inputs from manure and plants, as well as their respective monthly allocations.
```{r }
# define timeperiod 
period = define_timeperiod(yr_start = 1951, yr_end = 2019)

# get annual Carbon inputs 
cin = define_Cinputs(management_filepath = basic_example)

# get management 
management = management_config(management_filepath = basic_example, f_man_humification = 0.192)

# get soil configuration 
soil = soil_config(Csoil_init = 105, # Initial C stock at 1m depth
                   f_hum_top =  0.533,
                   f_rom_top =  0.405,
                   f_hum_sub =  0.387,
                   f_rom_sub =  0.610,
                   Cproptop = 0.55, # landmarkensite report askov
                   clay_top = 0.11,
                   clay_sub = 0.20,
                   phi = 0.035,
                   f_co2 = 0.628,
                   f_romi = 0.012,
                   k_fom  = 0.12,
                   k_hum = 0.0028,
                   k_rom = 3.85e-5,
                   ftr = 0.0025)
```

We also need to initialize soil pools before the simulation starts. Initial soil pools depend on the Carbon:Nitrogen ratio, the humification and romification fractions in top- and subsoils as well as the initial C stock.
```{r }
# initialize soil pools
soil_pools = initialize_soil_pools(cn = 12, soil_config = soil)
```

We can now start the monthly simulation. The verbose argument, currently set to FALSE, provides a check mass-balance to ensure the model is working correctly.
[Note to improve the mass balance, currently wrong]
```{r }
# run rCTOOL
output = run_ctool(time_config = period,
                   cin_config = cin,
                   m_config = management,
                   t_config = scenario_temperature,
                   s_config = soil,
                   soil_pools = soil_pools,
                   verbose = F)
```

We can plot the results.
```{r pressure, echo = FALSE, message = FALSE}
output |>
  mutate(time=make_date(year =yrs,month=mon)) |>
  ggplot(aes(x=time,y=C_topsoil))+
  geom_line()+
  geom_smooth()
```

## Management scenario example

Loading scenario management for Askov. 
```{r}
# load data ----
data('scenario')
data('scenario_temperature') # this is equivalent to set_monthly_temperature_data(coords=c(9.114015, 55.47163), yr_start=1951, yr_end=2019)
```

The scenario dataset contains three different management scenarios: a football court with ryegrass, an organic dairy farming and a pet cemitery. What are the implications in terms of soil organic C dynamics? rCTOOL can be used to explore the implications.
```{r ,echo = FALSE, message = FALSE}
require('ggplot2')

plot_df = reshape2::melt(scenario, c('mon','yrs','id','treatment'))
plot_df = plot_df |> 
  group_by(yrs, treatment, variable) |> 
  summarize(value=mean(value))

ggplot(data=subset(plot_df, value!=0), aes(x=yrs, y=value, colour=treatment)) + 
  geom_line(size=.8) + 
  facet_wrap(variable~., scales="free_y", ncol = 1,) + 
  theme_bw() + 
  labs(x='Management', y='Carbon inputs (tonnes/ha)', colour='Treatment') + 
  scale_y_continuous(expand=c(0,0), limits=c(0,4.5), breaks=seq(0,4,1)) + 
  scale_x_continuous(expand=c(0,0)) + 
  theme(text = element_text(size=16, family='serif'),
        axis.title = element_text(size=17, face='bold'),
        axis.text = element_text(size=16))
```
Provide timeperiod, management and soil config; initialize soil pools.
```{r}
period = define_timeperiod(yr_start = 1951, yr_end = 2019)

management = management_config(
  manure_monthly_allocation = c(0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0),
  plant_monthly_allocation = c(0, 0, 0, 8, 12, 16, 64, 0, 0, 0, 0, 0) / 100
) # set to default

soil = soil_config(Csoil_init = 100,
                   f_hum_top = 0.4803,
                   f_rom_top = 0.4881,
                   f_hum_sub = 0.3123,
                   f_rom_sub = 0.6847,
                   Cproptop = 0.47,
                   clay_top = 0.1,
                   clay_sub = 0.15,
                   phi = 0.035,
                   f_co2 = 0.628,
                   f_romi = 0.012,
                   k_fom  = 0.12,
                   k_hum = 0.0028, 
                   k_rom = 3.85e-5,
                   ftr = 0.003)
soil_pools = initialize_soil_pools(cn = 10, soil_config = soil)
```

Provide configuration for each treatment/scenario.
[This raises the question of whether we should also account for this kind of flexibility]
```{r}
treatment = unique(scenario$treatment)
cin_treatment = lapply(treatment, function(x) { define_Cinputs(management_filepath = subset(scenario, treatment==x)) })
names(cin_treatment) = treatment
```

Run simulation for each treatment/scenario.
```{r}
output_treatment = lapply(treatment, function(x) {
  output = run_ctool(time_config = period, 
            cin_config = cin_treatment[[x]], 
            m_config = management, 
            t_config = scenario_temperature, 
            s_config = soil, 
            soil_pools = soil_pools)
  output$treatment = x
  return(output)
})
output_treatment = data.table::rbindlist(output_treatment)
```

Plot the impact on management of each treatment.
```{r echo = FALSE, message = FALSE}

plot_df = output_treatment[, c('mon','yrs','C_topsoil','C_subsoil','em_CO2_total', 'treatment')]
plot_df = reshape2::melt(plot_df, c('mon','yrs','treatment'))

labels = c(
  C_topsoil = 'SOC topsoil',
  C_subsoil = 'SOC subsoil',
  em_CO2_total = 'CO2 emissions'
)

ggplot(plot_df, aes(x=yrs, y=value, colour=treatment)) + 
  geom_line() + 
  geom_smooth() +
  facet_wrap(variable~., scales = 'free_y', ncol = 1,
             labeller = as_labeller(labels)) + 
  theme_bw() + 
  labs(x='Years', y='Output (tonnes/ha)', colour='Treatment') + 
  scale_y_continuous(expand=c(0,0)) + 
  scale_x_continuous(expand=c(0,0), breaks=c(1960, 2010)) + 
  theme(text = element_text(size=16, family='serif'),
        axis.title = element_text(size=17, face='bold'),
        axis.text = element_text(size=16))
```


